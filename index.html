<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Aphorisms of API Design</title>
    <link rel="stylesheet" href="components/require.css" />
    <link rel="stylesheet" href="components/revealjs/css/theme/default.css" />
    <link rel="stylesheet" href="components/revealjs/lib/css/zenburn.css" />
    <style>
      .top-align {
        position: absolute;
        top: -6em;
      }
      h1.inverse,
      h2.inverse,
      h3.inverse,
      h4.inverse,
      p.inverse {
        color: #000;
      }
      .reveal pre {
        width: 100%;
      }

      .drupal-marker {
        width: 100px;
        position: absolute;
        right: 50px;
        bottom: 50px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Aphorisms of<br />API Design</h1>
          <p>
            <small>Presented by <a href="http://www.garfieldtech.com/">Larry Garfield</a></small>
          </p>
        </section>
        <section>
          <h2><a href="http://twitter.com/Crell">@Crell</a></h2>
          <img src="assets/palantirnet-logo-2013.svg" alt="Palantir.net Pays me!" style="width: 300px; background: #FFF; float: right;" />
          <ul>
            <li>Senior Architect, <a href="http://www.palantir.net/">Palantir.net</a></li>
            <li>Drupal 8 Web Services Lead</li>
            <li>Drupal Representative, <a href="http://www.php-fig.org/">PHP-FIG</a></li>
            <li>Advisor, Drupal Association</li>
            <li>General busybody</li>
          </ul>
        </section>
        <section>
          <section>
            <h2>Step 1:</h2>
            <h2>Define your terms</h2>
          </section>
          <section>
            <h2>API</h2>
            <h3>Application Programming Interface</h3>
            <p class="fragment">Code intended for other code</p>
          </section>
          <section>
            <h2>Aphorism</h2>
            <blockquote>A concise statement containing a subjective truth or observation cleverly and pithily written.</blockquote>
            <p>&mdash; <a href="http://en.wikipedia.org/wiki/Aphorism">Wikipedia</a></p>
          </section>
          <section>
            <h3>They're not rules</h3>
            <img src="assets/captain-barbados.gif" alt="They're more like guidelines..." data-credit="http://www.killerfilm.com/articles-2/read/captain-barbados-confirmed-for-pirates-4-14377" />
            <h3>They're more like guidelines</h3>
          </section>
          <section>
            <h2>Our Agenda</h2>
            <p>Clever and pithy sayings about good code.</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#1</h1>
          </section>
          <section>
            <h2>Asimov's Law</h2>
            <blockquote>If there are multiple universes,<br />then there are infinite universes</blockquote>
            <p>&mdash; <em>The Gods Themselves</em></p>
          </section>
          <section>
            <p>If there are multiple possible implementations,<br />there are infinite possible implementations</p>
          </section>
          <section>
            <h2>So what?</h2>
            <p>Machine names > Constants</p>
          </section>
          <section>
            <pre><code class="php">
const STATUS_PUBLISHED = 1;
const STATUS_DRAFT = 0;

function load_articles_by_status($status) {
  // Find articles $ids for $status
  return article_load_multiple($ids);
}</code></pre>
          </section>
          <section>
            <p>Oops</p>
            <pre><code class="php">const MYMODULE_STATUS_PENDING = 3;

const YOURMODULE_STATUS_IN_REVIEW = 3;</code></pre>
          </section>
          <section>
            <pre><code class="php">
function load_articles_by_status($status = '') {
  // Find articles $ids for $status
  return article_load_multiple($ids);
}</code></pre>
          </section>
          <section>
            <p>Boolean != either/or</p>
            <p class="fragment">Booleans don't have 2 values</p>
            <p class="fragment">Booleans are <code>TRUE</code> or not</p>
          </section>
          <section>
            <p>Access is a boolean</p>
            <p>Access control has N-possibilities</p>
          </section>
          <section>
            <h3>Garfield's Law</h3>
            <q>One is a special case of many.</q>
            <p>&mdash; <a href="http://groups.drupal.org/node/8001">http://groups.drupal.org/node/8001</a></p>
          </section>
          <section>
            <code>node_load_multiple()</code>
            <img src="assets/druplicon.svg" alt="Druplicon" data-credit="http://drupal.org/druplicon" class="drupal-marker" />
          </section>
          <section>
            <h3>Drupal 6</h3>
            <pre><code class="php">// Fetch one node.
function node_load($nid) {
  $record = db_query("SELECT * FROM node WHERE nid=:nid", array(':nid' => $nid))
    ->fetchObject();
  $record = load_extra_stuff($record);
  return $record;
}

// Fetch multiple nodes.
function node_load_multiple(array $nids) {
  $records = db_query("SELECT * from node WHERE nid IN (:nids)", ':nids' = $nids)
    ->fetchAll();
  foreach ($records as $record) {
    $loaded[] = load_extra_stuff($record);
  }
  return $loaded;
}</code></pre>
          </section>
          <section>
            <h2>SELECT N + 1</h2>
            <p class="fragment">(aka, melt your database)</p>
          </section>
          <section>
            <h3>Drupal 7</h3>
              <pre><code class="php">// Fetch one node.
function node_load($nid) {
  $nods = node_load_multiple(array($nid));
  return reset($nodes);
}

// Fetch multiple nodes.
function node_load_multiple(array $nids) {
  $records = db_query("SELECT * from node WHERE nid IN (:nids)", ':nids' = $nids)
    ->fetchAll();
  $records = load_extra_stuff($records);
  return $records;
}</code></pre>
            </section>
          <section>
            <h2>Aphorism #1</h2>
            <p>N is the only number</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#2</h1>
          </section>
          <section>
            <q>Fail Fast, Fail Cheap, Be Lazy.</q>
            <p>&mdash; Rasmus Lerdorf</p>
          </section>
          <section>
            <p>Make the code debug for you</p>
          </section>
          <section>
            <p>Don't plan for everything that could happen</p>
            <p class="fragment">Plan for how it will break</p>
          </section>
          <section>
            <h2>Drupal 6 theme system</h2>
            <pre><code class="php">function theme($hook) {
  // ...
  if (!isset($hooks[$hook])) {
    return;
  }
  // ...
  return $output;
}</code></pre>
          </section>
          <section>
            <h2>Drupal 7 theme system</h2>
            <pre><code class="php">function theme($hook, $variables = array()) {
  // ...
  if (!isset($hooks[$hook])) {
    if (!isset($candidate)) {
      watchdog('Theme key "{$hook}" not found.');
    }
    return '';
  }
  // ...
  return $output;
}</code></pre>
          </section>
          <section>
            <p>General failure reading Drive C:</p>
            <p class="fragment"><code>PHP Warning:  Invalid argument supplied for foreach() in /includes/form.inc on line 2975</code></p>
          </section>
          <section>
            <p>Code failure is like voting in Chicago</p>
          </section>
          <section>
            <h2>Fail early, fail often</h2>
            <p class="fragment">Constrain inputs</p>
            <p class="fragment">Fail usefully</p>
          </section>
          <section>
            <h3>Good APIs are picky</h3>
            <pre><code class="php">class InsertQuery extends Query {
  public function fields(array $fields,
                         array $values = array()) {
    // ...
  }
  public function preExecute() {
    if (array_intersect($iFields, $defaultFields)) {
      throw new FieldsOverlapException('...');
    }
    // ...
    return TRUE;
  }
}</code></pre>
          </section>
          <section>
            <blockquote>A good programmer is someone who always looks both ways before crossing a one-way street.</blockquote>
            <p>&mdash; Doug Linder</p>
          </section>
          <section>
            <p>If you're not developing under
              <strong>E_ALL|E_STRICT</strong>,<br /><em>you're doing it wrong</em>.</p>
          </section>
          <section>
            <h2>Aphorism #2</h2>
            <p>Fail fast, fail cheap, fail usefully</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#3</h1>
          </section>
          <section>
            <h2>You want to...</h2>
            <ol>
              <li class="fragment">Let other modules/plugins define new components</li>
              <li class="fragment">Implement it yourself</li>
              <li class="fragment">No undocumented APIs (Don't be Windows)</li>
            </ol>
          </section>
          <section>
            NEEDS NON-DRUPAL SAMPLES
          </section>
          <section>
            <h2>Aphorism #3</h2>
            <p>Obey your own rules</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#4</h1>
          </section>
          <section>
            <p>A UI is not an API</p>
          </section>
          <section>
            <p>A <em>User Interface</em> is not an <em>Application Programming Interface</em></p>
          </section>
          <section>
            <p>A User is not a Program</p>
          </section>
          <section fullscreen-img="assets/tron.jpg" class="fullscreen">
            &nbsp;
          </section>
          <section>
            <p>A UI is a client of your API</p>
          </section>
          <section>
            <p>What good is a website without a UI?</p>
            <p class="fragment">Who said you're building a web site?</p>
          </section>
          <section>
            <img src="assets/website-cilex.png" alt="Cilex, the command line micro-framework" />
          </section>
          <section>
            <h2><a href="http://phpunit.de"><img src="assets/phpunit.png" width="195" height="135" alt="PHPUnit" style="background:none; border: none; vertical-align: middle;"></a> PHPUnit</h2>
          </section>
          <section>
            <img src="assets/website-halbrowser.png" alt="The HAL Browser, a generic reference implementation" />
          </section>
          <section>
            <img src="assets/node-add-form.png" alt="Drupal, the world's best Open Source CMS" />
          </section>
          <section>
            <p>A website is not an API</p>
          </section>
          <section>
            <p>A website <em>uses</em> an API</p>
          </section>
          <section>
            <p>An API does not need a web site</p>
          </section>
          <section>
            <p>You're not done until you have 3 implementations</p>
          </section>
          <section>
            <h2>3 implementations?</h2>
            <ol>
              <li class="fragment">Unit test</li>
              <li class="fragment">Web services call</li>
              <li class="fragment">Command line</li>
              <li class="fragment">Web site</li>
            </ol>
          </section>
         <section>
            <h2>Aphorism #4</h2>
            <p>A UI is not an API</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#5</h1>
          </section>
          <section>
            <blockquote>You know that saying about standing on the shoulders of giants?<br />
              Drupal is standing on a huge pile of midgets.</blockquote>
            <p>&mdash; Jeff Eaton</p>
          </section>
          <section>
            <img src="assets/wheel-reinvented.jpg" alt="Don't reinvent the wheel. We have enough already." style="max-width: 80%" data-credit="http://www.flickr.com/photos/conskeptical/191048988" />
          </section>
          <section>
            <p>Don't add to API bloat</p>
          </section>
          <section>
            <img src="assets/xkcd-standards.png" alt="There are too many APIs in the world" data-credit="http://xkcd.com/927/" />
          </section>
          <section>
            <h2>Leverage existing patterns</h2>
            <ul>
              <li class="fragment">Mimicry is the highest form of flattery</li>
              <li class="fragment">Mimicry is easier to remember</li>
              <li class="fragment">Mimicry takes less work</li>
            </ul>
          </section>
          <section>
            NEED NON-DRUPAL CODE SAMPLES
            REFERENCE DESIGN PATTERNS?
          </section>
          <section>
            <h2>Aphorism #5</h2>
            <p>The best API is the API you didn't have to write</p>
          </section>
        </section>
        <section>
          <section>
            <h1>#6</h1>
          </section>
          <section>
            <blockquote>Use uncertainty as a driver.</blockquote>
            <p>&mdash; Kevlin Henney, <a href="http://97things.oreilly.com/wiki/index.php/97_Things_Every_Software_Architect_Should_Know_-_The_Book">97 Things Every Software Architect Should Know</a></p>
          </section>
          <section>
            <p>Don't make decisions if you don't have to.</p>
            <p class="fragment">Make changing your mind cheap.</p>
            <br /><br />
            <p class="fragment">(Your client <em>will</em> change his mind.)</p>
            <p class="fragment">(Twice.)</p>
          </section>
          <section>
            <p>You can only change what is encapsulated.</p>
          </section>
          <section>
            <h2>Logging</h2>
            <ul>
              <li class="fragment">Database</li>
              <li class="fragment">Syslog</li>
              <li class="fragment">Display on screen</li>
              <li class="fragment">Pager / SMS message</li>
              <li class="fragment">Twitter</li>
            </ul>
            <br />
            <p class="fragment">Don't decide for me!</p>
          </section>
          <section>
            <h3>Interfaces are your friend</h3>
            <pre><code class="php">interface LogInterface {
  public method log($message, $severity);
}</code></pre>
          </section>
          <section>
            <h3>PSR-3</h3>
            <pre><code class="php">namespace Psr\Log;

interface LoggerInterface {
  public function log($level, $message, array $context = array());

  public function emergency($message, array $context = array());
  public function alert($message, array $context = array());
  public function critical($message, array $context = array());
  public function error($message, array $context = array());
  public function warning($message, array $context = array());
  public function notice($message, array $context = array());
  public function info($message, array $context = array());
  public function debug($message, array $context = array());
}</code></pre>
          </section>
          <section>
            <h3>Caching</h3>
            <ul>
              <li class="fragment">Database</li>
              <li class="fragment">APC</li>
              <li class="fragment">Memcache</li>
              <li class="fragment">Redis</li>
              <li class="fragment">Riak</li>
            </ul>
            <p class="fragment">Don't decide for me!</p>
          </section>
          <section>
            <h3>In Drupal</h3>
            <pre><code class="php">interface DrupalCacheInterface {
  function get($cid);
  function getMultiple(&$cids);
  function set($cid, $data, $expire = CACHE_PERMANENT);
  function clear($cid = NULL, $wildcard = FALSE);
  function isEmpty();
}</code></pre>
          </section>
          <section>
            <h2>Cache PSR</h2>
            <p>Stay tuned... ;-)</p>
          </section>
          <section>
            <p>Encapsulation avoids decision making</p>
            <p class="fragment">Avoiding decision making requires loose coupling</p>
          </section>
          <section>
            <h3>Explicit interfaces</h3>
            <pre><code class="php">namespace Psr\Log;

interface LoggerInterface {
  public function log($level, $message, array $context = array());

  public function emergency($message, array $context = array());
  public function alert($message, array $context = array());
  public function critical($message, array $context = array());
  public function error($message, array $context = array());
  public function warning($message, array $context = array());
  public function notice($message, array $context = array());
  public function info($message, array $context = array());
  public function debug($message, array $context = array());
}</code></pre>
          </section>
          <section>
            <h2>Separate Logic from Data</h2>
            <div>
              <div style="float: left;"><img src="assets/spock.jpg" alt="Logic" style="max-height: 400px;" /></div>
              <div style="float: right;"><img src="assets/data.jpg" alt="Data"  style="max-height: 400px;" /></div>
            </div>
          </section>
          <section>
            <h2>Separation of concerns</h2>
            <ul>
              <li class="fragment">Interface-driven development</li>
              <li class="fragment">Context-free (stateless) services</li>
              <li class="fragment">Single-Responsibility Principle</li>
              <li class="fragment">Dependency injection</li>
            </ul>
          </section>
          <section>
            <h2>Aphorism #6</h2>
            <p>You cannot delegate what you cannot separate</p>
          </section>
        </section>
      </div>
    </div>
    <script type="text/javascript" src="components/require.js" data-main="aphorisms-api"></script>
  </body>
</html>
